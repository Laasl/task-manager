<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Gestionnaire de t√¢ches avec Firebase</title>
<style>
body {
font-family: Arial, sans-serif;
font-size: 20px;
line-height: 1.6;
padding: 20px;
background: #f5f5f5;
}
h2 {
margin-top: 40px;
}
form input, form textarea, form button {
font-size: 18px;
padding: 10px;
margin: 5px 0;
box-sizing: border-box;
}
form input[type="date"] {
width: 48%;
}
form input[type="text"], form textarea {
width: 100%;
}
.task {
border-radius: 10px;
border: 1px solid #ccc;
padding: 20px;
margin: 15px 0;
cursor: pointer;
transition: background-color 0.3s ease;
position: relative;
}
.task.non-commence {
background-color: #ffffff;
color: #000;
}
.task.en-cours {
background-color: #ffb74d;
color: #000;
}
.task.termine {
background-color: #4caf50;
color: #fff;
text-decoration: line-through;
}
.description {
font-size: 20px;
margin: 10px 0;
}
.pilote {
font-style: italic;
font-size: 18px;
}
.edit-btn {
position: absolute;
top: 10px;
right: 10px;
font-size: 18px;
background: none;
border: none;
cursor: pointer;
}
button {
padding: 12px 20px;
font-size: 18px;
margin-top: 10px;
cursor: pointer;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBqjP4QxVKT0LbNvSMVcdrhH0IKji4_XpA",
authDomain: "pdca-fb469.firebaseapp.com",
projectId: "pdca-fb469",
storageBucket: "pdca-fb469.firebasestorage.app",
messagingSenderId: "207233804691",
appId: "1:207233804691:web:c3f0ba6bc1212a2276e066",
measurementId: "G-SBW3W8TJ09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const taskForm = document.getElementById('taskForm');
const taskListDiv = document.getElementById('taskList');
const deleteDoneBtn = document.getElementById('deleteDone');

const statusCycle = ['Non commenc√©', 'En cours', 'Termin√©'];

let editTaskId = null;

function renderTasks(tasks) {
taskListDiv.innerHTML = '';
tasks.forEach(task => {
const div = document.createElement('div');
div.className = 'task ' + (task.status === 'Non commenc√©' ? 'non-commence' : task.status === 'En cours' ? 'en-cours' : 'termine');
div.innerHTML = `
<button class="edit-btn" title="Modifier">‚úèÔ∏è</button>
<strong>${task.title}</strong><br>
<div class="description">${task.description}</div>
<div class="pilote">üë§ Pilote : ${task.pilote}</div>
Du ${task.startDate} au ${task.endDate}<br>
<em>Statut: ${task.status}</em>
`;

// Changer statut au clic sur la carte
div.onclick = async (e) => {
if (e.target.classList.contains('edit-btn')) return; // √©viter conflit avec bouton modifier
const currentIndex = statusCycle.indexOf(task.status);
const nextStatus = statusCycle[(currentIndex + 1) % statusCycle.length];
await updateDoc(doc(db, 'tasks', task.id), { status: nextStatus });
};

// Bouton modifier
div.querySelector('.edit-btn').onclick = (e) => {
e.stopPropagation();
taskForm.title.value = task.title;
taskForm.description.value = task.description;
taskForm.pilote.value = task.pilote || '';
taskForm.startDate.value = task.startDate;
taskForm.endDate.value = task.endDate;
editTaskId = task.id;
};

taskListDiv.appendChild(div);
});
}

const q = query(collection(db, 'tasks'), orderBy('startDate'));
onSnapshot(q, (snapshot) => {
const tasks = [];
snapshot.forEach(doc => {
tasks.push({ id: doc.id, ...doc.data() });
});
renderTasks(tasks);
});

taskForm.addEventListener('submit', async e => {
e.preventDefault();
const title = taskForm.title.value.trim();
const description = taskForm.description.value.trim();
const pilote = taskForm.pilote.value.trim();
const startDate = taskForm.startDate.value;
const endDate = taskForm.endDate.value;

if (!title || !description || !startDate || !endDate || !pilote) {
alert("Merci de remplir tous les champs");
return;
}

if (editTaskId) {
await updateDoc(doc(db, 'tasks', editTaskId), {
title, description, pilote, startDate, endDate
});
editTaskId = null;
} else {
await addDoc(collection(db, 'tasks'), {
title,
description,
pilote,
startDate,
endDate,
status: 'Non commenc√©'
});
}

taskForm.reset();
});

deleteDoneBtn.onclick = async () => {
const confirmDelete = confirm("Supprimer toutes les t√¢ches marqu√©es comme 'Termin√©' ?");
if (!confirmDelete) return;

const snapshot = await getDocs(collection(db, 'tasks'));
const batchDeletes = snapshot.docs
.filter(docSnap => docSnap.data().status === 'Termin√©')
.map(docSnap => deleteDoc(doc(db, 'tasks', docSnap.id)));

await Promise.all(batchDeletes);
};
</script>
</head>
<body>
<h2>Ajouter ou modifier une t√¢che</h2>
<form id="taskForm">
<input name="title" type="text" placeholder="Titre" required />
<textarea name="description" placeholder="Description" required style="height: 80px;"></textarea>
<input name="pilote" type="text" placeholder="Pilote" required />
<div style="display: flex; gap: 4%;">
<input name="startDate" type="date" required />
<input name="endDate" type="date" required />
</div>
<button type="submit">Enregistrer</button>
</form>

<h2>Liste des t√¢ches</h2>
<div id="taskList"></div>
<button id="deleteDone">üóëÔ∏è Supprimer les t√¢ches termin√©es</button>
</body>
</html>